#!/bin/sh -e

main() {
	test -n "$1" || fail "usage: ${0##*/} action [args]"
	BASE="$HOME/prv/conf"
	action="$1"
	now=$(date +%Y%m%d-%H%M%S)

	case "$action" in
		httpd)
			f_h="$BASE/$2/etc/httpd.conf"
			f_r="$BASE/$2/etc/relayd.conf"

			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			test -f "$f_h" || fail "no $f_h"
			test -f "$f_r" || fail "no $f_r"

			scp "$f_r" "$f_h" "$2":/etc/

			ssh "$2" 'set -xe
rcctl enable httpd
rcctl enable slowcgi
rcctl enable relayd
httpd -n
relayd -n
rcctl restart httpd
rcctl restart relayd
'
			;;

		acme_s1)
			f_a="$BASE/s1/etc/acme-client.conf"
			test -f "$f_a" || fail "no $f_a"
			scp "$f_a" s1:/etc/

			ssh s1 'set -xe
acme-client -n www.romanzolotarev.com
acme-client -v www.romanzolotarev.com
rcctl reload httpd
'
			mkdir -p s1/etc/ssl/private
			scp s1:/etc/ssl/private/s1.key s1/etc/ssl/private/
			scp s1:/etc/ssl/s1.{crt,pem} s1/etc/ssl/
			;;

		acme_s2)
			test -f "$f_a" || fail "no $f_a"
			scp s1/etc/ssl/private/s1.key s2:/etc/ssl/private/
			scp s1/etc/ssl/s1.{crt,pem} s2:/etc/ssl/
			;;

		nsd)
			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			f_n="$BASE/s1/var/nsd/etc/nsd.conf"
			test -f "$f_n" || fail "no $f_n"
			nsd-checkconf "$f_n"
			scp "$f_n" "$2":/var/nsd/etc/
			scp "$BASE/s1/var/nsd/zones/master/"* "$2":/var/nsd/zones/master/
			ssh "$2" 'set -xe && rcctl restart nsd'
			;;

		setup_smtpd)
			f="$BASE/s1/etc/mail/smtpd.conf"
			test -f "$f" || fail "no $f"
			scp "$f" s1:/etc/mail/smtpd.conf

			pass show etc-mail-secrets-s2 |
			scp /dev/stdin s2:/etc/mail/secrets
			ssh s2 'smtpd -n && rcctl restart smtpd'

			echo 'continue?' && read -r
			pass show etc-mail-secrets-s1 |
			scp /dev/stdin s1:/etc/mail/secrets
			ssh s1 'smtpd -n && rcctl restart smtpd'
			;;

		install_ssg)
			f="$HOME/bin/ssg4"
			test -f "$f" || fail "no $f"

			scp "$f" git@s2:bin/ssg4

			echo 'continue?' && read -r
			scp "$f" git@s1:bin/ssg4
			;;

		*) fail 'invalid action';;
	esac

}

fail() { echo "$1"; exit 1; }

main "$@"
