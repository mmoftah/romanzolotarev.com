#!/bin/sh -e

LINK_CERTS='
ln -fs /etc/ssl/private/s1.key /etc/ssl/private/46.23.88.178.key
ln -fs /etc/ssl/private/s1.key /etc/ssl/private/2a03:6000:1015::178.key
ln -fs /etc/ssl/s1.pem /etc/ssl/46.23.88.178.crt
ln -fs /etc/ssl/s1.pem /etc/ssl/2a03:6000:1015::178.crt
ln -fs /etc/ssl/private/s1.key /etc/ssl/private/140.82.28.210.key
ln -fs /etc/ssl/private/s1.key /etc/ssl/private/2001:19f0:9002:1505:5400:1ff:fe73:6676.key
ln -fs /etc/ssl/s1.pem /etc/ssl/140.82.28.210.crt
ln -fs /etc/ssl/s1.pem /etc/ssl/2001:19f0:9002:1505:5400:1ff:fe73:6676.crt
'

main() {
	test -n "$1" || fail "usage: ${0##*/} action [args]"
	BASE="$HOME/prv/conf"
	action="$1"
	now=$(date +%Y%m%d-%H%M%S)

	case "$action" in
		httpd)
			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			scp \
				"$BASE/$2/etc/relayd.conf" \
				"$BASE/s1/etc/httpd.conf" "$2":/etc/
			ssh "$2" 'set -xe
'"$LINK_CERTS"'
rcctl enable httpd
rcctl enable slowcgi
rcctl enable relayd
httpd -n
relayd -n
rcctl restart httpd
rcctl restart relayd
'
			;;

		acme_s1)
			scp "$BASE/s1/etc/acme-client.conf" s1:/etc/
			ssh s1 'set -xe
test -f /etc/ssl/s1.crt && mv /etc/ssl/s1.crt /etc/ssl/s1.crt.bak
acme-client -n www.romanzolotarev.com
#acme-client -vFAD www.romanzolotarev.com
'"$LINK_CERTS"
			mkdir -p "$BASE/s1/etc/ssl/private"
			rm -f "$BASE/s1/etc/ssl/s1.pem"
			rm -f "$BASE/s1/etc/ssl/s1.crt"
			rm -f "$BASE/s1/etc/ssl/s1.crt.bak"
			scp s1:/etc/ssl/s1.* "$BASE/s1/etc/ssl/"
			rm -f "$BASE/s1/etc/ssl/private/s1.key"
			scp s1:/etc/ssl/private/s1.key "$BASE/s1/etc/ssl/private/"
			;;

		acme_s2)
			scp "$BASE/s1/etc/ssl/s1."* s2:/etc/ssl/
			scp "$BASE/s1/etc/ssl/private/s1.key" s2:/etc/ssl/private/
			ssh s2 'set -xe && acme-client -n www.romanzolotarev.com && rcctl reload relayd'
			;;

		nsd)
			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			nsd-checkconf "$BASE/s1/var/nsd/etc/nsd.conf"
			scp "$BASE/s1/var/nsd/etc/nsd.conf" "$2":/var/nsd/etc/
			scp "$BASE/s1/var/nsd/zones/master/"* "$2":/var/nsd/zones/master/
			ssh "$2" 'set -xe && rcctl restart nsd'
			;;

		smtpd)
			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			scp "$BASE/$2/etc/mail/smtpd.conf" "$2":/etc/mail/smtpd.conf
			pass show etc-mail-secrets-"$2" | scp /dev/stdin "$2":/etc/mail/secrets
			ssh "$2" 'set -xe && smtpd -n && rcctl restart smtpd'
			;;

		ssg)
			test -n "$2" || fail "usage: ${0##*/} $1 hostname"
			scp "$HOME/bin/ssg4" "$HOME/bin/rssg" git@"$2":bin/
			;;

		*) fail 'invalid action';;
	esac

}

fail() { echo "$1"; exit 1; }

main "$@"
