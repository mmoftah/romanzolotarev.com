#!/bin/sh -e

main () {
	DB='/var/www/db/www'
	test -d "$DB" || fail "$DB: not found"
	EXP_TIME='3600'
	FROM='hi@romanzolotarev.com'
	NAME='Roman Zolotarev'

	dispatch_mail
	remove_expired_tokens
	remove_expired_memberships
}

##########################################################################


dispatch_mail() {
	dir="$DB/mail_queue"
	test -d "$dir" || return
	find "$dir" -type f | head -n 100 |
	while read -r m
	do
		test -f "$m" || break
		sendmail -t -F "$NAME" -f "$FROM" < "$m"
		head -n 1 "$m"
		rm -v "$m"
	done
}


remove_expired_tokens() {
	dir="$DB/tokens"
	test -d "$dir" || return
	find "$dir" -type f -cmin "+$(( EXP_TIME / 60 ))" -delete
}


remove_expired_memberships() {
	dir="$DB/members"
	test -d "$dir" || return
	now=$(date +%s)
	find "$dir" -type f -name 'expires_at' |
	while read -r f
	do
		e_at=$(cat "$f")
		e_in=$((e_at - now))
		echo "${f%%/expires_at}: $e_at - $now = $e_in"
		test "$e_in" -lt 0 && rm -v "${f:?}"
	done
}


##########################################################################

fail() {
	>&2 echo "$1"
	exit 1
}

main
